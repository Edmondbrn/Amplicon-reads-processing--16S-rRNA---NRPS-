---
title: "NRPS analysis"
author: "Edmond Berne"
date: "2024-08-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loading_packages, include=FALSE}
.libPaths("/home/edmond/R/x86_64-pc-linux-gnu-library/4.3") # path to the R libraries (personnal environnement)
library(phyloseq)
library(ampvis2)
library(ggplot2)
library(vegan)
library(dplyr)
library(tidyr)
library(readxl)
library(rprojroot)
library(ggpubr)
library(VennDiagram)
library(plotly)
library(ggbeeswarm)
library(vegan)
# format the html output
library(kableExtra)
```

```{r set the working directory, include=FALSE}
tryCatch({
    root = find_root(is_rstudio_project | is_r_package | has_file("analysis_NRPS_amplicon.Rmd"))
    setwd(root) # set the working directory to the location of this script
}, error = function(e){
    setwd("/home/edmond/scripts_frederik/NRPS")
    cat("Error with the automatic path detection, working directory set to: /home/edmond/scripts_frederik/NRPS\n")
}) 
```

```{r loading_data, include=FALSE}

df_feature = read.csv("ressources/grouped-feature-table.tsv", sep = "\t")
df_tax = read.csv("ressources/amplicon_annotation.csv", sep = "\t")
df_meta = read_excel("ressources/Metadata.xlsx")


df_feature = df_feature %>%
  tibble::column_to_rownames("ASV")

df_tax = df_tax %>% 
  tibble::column_to_rownames("ASV")

df_meta = df_meta %>% 
  tibble::column_to_rownames("Sample_ID")

rownames(df_meta) = gsub("-", ".", rownames(df_meta)) # replace - by . in the sample names to be compatible with the feature table

otu_mat = as.matrix(df_feature)
tax_mat = as.matrix(df_tax)
OTU = otu_table(otu_mat, taxa_are_rows = TRUE)
TAX = tax_table(tax_mat)
samples = sample_data(df_meta)
physeq = phyloseq(OTU, TAX, samples)
saveRDS(physeq, "output/physeq_raw.rds")
physeq@sam_data$WEEK = ifelse(physeq@sam_data$WEEK == "2weeks", "week 2", 
                              ifelse(physeq@sam_data$WEEK == "4weeks", "week 4", "week 5"))
physeq_rhizoplane = subset_samples(physeq, Compartments == "rhizoplane") # subset the rhizoplane samples
physeq_rhizosphere = subset_samples(physeq, Compartments == "rhizosphere") # subset the rhizosphere samples

physeq_rhizosphere_ctrl = subset_samples(physeq_rhizosphere, Treatment == "Control") # objects to use to study the control samples only
physeq_rhizosplane_ctrl = subset_samples(physeq_rhizoplane, Treatment == "Control")
```


```{r rarefaction curves, include=TRUE}
Rarecurve = function(data, col="WEEK", facet = "Treatment", type) { 
  cat("Creating rarefaction curve for ", type, " samples\n")
  p1 = amp_rarecurve(data, color_by = col, stepsize = 100, facet_by = facet)
  p1 = p1 + theme(axis.text = element_text(size = 14), 
             axis.title = element_text(size = 20), 
             legend.text = element_text(size = 18), 
             legend.title = element_text(size = 20)) +
    theme(axis.text.x = element_text(angle = 0, hjust = 0.5, size = 14),
    strip.text = element_text(size = 20)) + # Agrandir le texte du titre de chaque facette + # Mettre les graduations Ã  l'horizontale et les agrandir
    labs(y = "Number of ASVs")+
    geom_line(linewidth = 1.5)
  cat("Saving the plot\n")
  ggsave(paste0("output/rarefaction_curve_control_", type ,".png"), width = 10, height = 10)
  return(p1)
}
update_week = function(amp_data){
  amp_data$metadata$WEEK = ifelse(amp_data$metadata$WEEK == "2weeks", "week 2",
                                  ifelse(amp_data$metadata$WEEK == "4weeks", "week 4", "week 5"))
  return(amp_data)
}
```

```{r rarefaction curves_load, include=TRUE}
amp_rhizosphere = amp_load(physeq_rhizosphere_ctrl) # creation of the ampvis2 object
amp_rhizosphere = update_week(amp_rhizosphere)
amp_rhizoplane = amp_load(physeq_rhizosplane_ctrl)
amp_rhizoplane = update_week(amp_rhizoplane)
```

```
### Rarefaction curves
- Rhizoplane
```{r rarecurve_rhizoplane, include = TRUE}
(plot_rhizoplane = Rarecurve(amp_rhizoplane, "WEEK", "Treatment", "rhizoplane"))
```
42000 looks good for the rhizoplane samples. We will use this value for the rarefaction of the rhizoplane samples

- Rhizosphere
```{r rarecurve_rhizosphere, include = TRUE}
plot_rhizosphere = Rarecurve(amp_rhizosphere, "WEEK", "Treatment", "rhizosphere")
plot_rhizosphere
```
40000 looks good for the rhizosphere samples. We will use this value for the rarefaction of the rhizosphere samples

```{r rarefaction process, include = FALSE}

rarefaction = function(physeq_obj, type, size){
    rarefied_physeq_list = list() # a list to store the rarefied phyloseq objects
    for (i in 1:100) {
      rarefied_physeq = rarefy_even_depth(physeq_obj, sample.size = size, rngseed = i)
      rarefied_physeq_list[[i]] = rarefied_physeq
      cat("Loop number: \r", i, "out of 100")
    }
    otu_tables = lapply(rarefied_physeq_list, function(x) otu_table(x)) # regroup all the otu_tables in a list

    cat("All the rarefied phyloseq objects have been created")
    cat("Converting otu_tables to dataframes...")

    for (i in 1:length(otu_tables)) { # convert all the otu_tables to dataframes
      otu_tables[[i]] = as.data.frame(otu_tables[[i]])
      otu_tables[[i]]$ASV = rownames(otu_tables[[i]])
      cat("Loop number: \r", i, "out of 100")
    }

    cat("Dataframes created")
    cat("Concatenating dataframes...")

    df_rare = as.data.frame(otu_tables[[1]]) # create a dataframe with the first otu_table for later
    for (i in 2:length(otu_tables)) { # Concatenate all the dataframes vertically
      df_rare = rbind(df_rare, as.data.frame(otu_tables[[i]]))
      cat("Loop number: \r", i, "out of 100")
    }

    cat("Rarefied dataframe created\n")
    cat("Calculating mean and median...\n")

    # Regroup rows by NAME and calculate the mean and median
    df_rare_mean = df_rare %>% group_by(ASV) %>% summarise(across(everything(), list(mean = mean)))
    df_rare_median = df_rare %>% group_by(ASV) %>% summarise(across(everything(), list(median = median)))

    names(df_rare_mean) = sub("_mean", "", names(df_rare_mean)) # Remove mean and median to column names
    names(df_rare_median) = sub("_median", "", names(df_rare_median))

    df_rare_mean = df_rare_mean %>%
      tibble::column_to_rownames("ASV")

    df_rare_median = df_rare_median %>%
      tibble::column_to_rownames("ASV")

    df_rare_mean = otu_table(df_rare_mean, taxa_are_rows = TRUE)
    df_rare_median = otu_table(df_rare_median, taxa_are_rows = TRUE)
    Rarefied_physeq_mean = phyloseq(df_rare_mean, TAX, samples) # create another phyloseq object with rarefied data as OTU table
    Rarefied_physeq_median = phyloseq(df_rare_median, TAX, samples)

    otu_data = round(otu_table(Rarefied_physeq_mean))
    # In case where we have float number in mean (for richness), we round the number to have an integer
    Rarefied_physeq_mean_rounded = phyloseq(otu_data, TAX, samples)

    cat("Saving the object to RDS format...\n")
    saveRDS(Rarefied_physeq_mean_rounded, file = paste0("output/Rarefied_physeq_mean_rounded_", type, ".rds"))
    saveRDS(Rarefied_physeq_median, file = paste0("output/Rarefied_physeq_median_", type ,".rds"))
    saveRDS(df_rare_mean, file = paste0("output/df_rare_mean_", type ,".rds"))
}
cat("Starting the rarefaction process for the rhizoplane samples\n")
rarefaction(physeq_rhizosplane_ctrl, "rhizoplane", size = 40000)
cat("Starting the rarefaction process for the rhizosphere samples\n")
rarefaction(physeq_rhizosphere_ctrl, "rhizosphere", size = 40000)

```

```{r loading the rarefied phyloseq objects, include=FALSE}
Rarefied_physeq_mean_rounded_rhizoplane = readRDS("output/Rarefied_physeq_mean_rounded_rhizoplane.rds")
Rarefied_physeq_median_rhizoplane = readRDS("output/Rarefied_physeq_median_rhizoplane.rds")
df_rare_mean_rhizoplane = readRDS("output/df_rare_mean_rhizoplane.rds")

Rarefied_physeq_mean_rounded_rhizosphere = readRDS("output/Rarefied_physeq_mean_rounded_rhizosphere.rds")
Rarefied_physeq_median_rhizosphere = readRDS("output/Rarefied_physeq_median_rhizosphere.rds")
df_rare_mean_rhizosphere = readRDS("output/df_rare_mean_rhizosphere.rds")
```

### Descriptive statistics

```{r descriptive_statistics, include=TRUE}
reads_data = read.csv("ressources/track.txt", sep = "\t")
number_ASV = colSums(df_feature)
reads_data$ASV = number_ASV
reads_data$Treatment = df_meta$Treatment # add metadata to the reads data
reads_data$Compartments = df_meta$Compartments
table = reads_data %>% 
    filter(Treatment == "Control") %>% # remove this line to get data for all the samples
    group_by(Compartments) %>% 
    summarise(mean_reads = mean(nonchim), median_reads = median(nonchim), reads_number = sum(nonchim),
                                min_reads = min(nonchim), max_reads = max(nonchim), Cluster_sum = sum(ASV), samples = n())
table = as.data.frame(table)

table %>% # display the table with a good looking format
  kable("html", caption = "Descriptive Statistics") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "responsive"), full_width = F)

```

### Alpha diversity



```{r alpha diversity function, include = FALSE}

alpha_box_plot = function(data, x_var,y_var, col, facet, comparizon, nb_test, name){
  y_lab = ifelse(y_var == "Shannon", "Shannon diversity", "Chao1 richness")
  symnum = list(cutpoints = c(0, 0.0001/nb_test, 0.001/nb_test, 0.01/nb_test, 0.05/nb_test, Inf), symbols = c("****", "***", "**", "*", "ns"))
  formule = as.formula(paste0("~", facet))
  p = ggplot(data = data, aes_string(x = x_var, y = y_var, color = col))+
    geom_quasirandom(size = 4) +
    facet_grid(formule, scales = "free") + # organise the plot by week
    theme(axis.text.x = element_text(hjust = 1, size = 20, angle = 45),  
          axis.text.y = element_text(size = 20),  
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 18),
          plot.title = element_text(size = 20, face = "bold", hjust = 0.5),
          axis.title.x = element_text(size = 24),  
          axis.title.y = element_text(size = 24),
          strip.text = element_text(size = 15)) +  
    ylim(c(min(data[[y_var]]) - 0.1 * min(data[[y_var]]) , max(data[[y_var]]) + 0.1 *max(data[[y_var]]))) +
    labs(x = "Sub sample", y = y_lab)+
    stat_compare_means(comparisons = comparizon, symnum.args = symnum, label = "p.signif", size = 10 )
   ggsave(paste0("output/alpha_diversity_",name ,"_", y_var, ".png"), plot = p, width = 25, height = 15, units = "cm")
   return(p)
}

```

#### Compute the diversity and richness
```{r alpha_diversity, include=TRUE}
comparison = list(c("Watered", "Drought")) # add another paired vector in th elist for further comparizon
nb_test = 2
alpha_div_plane = estimate_richness(Rarefied_physeq_mean_rounded_rhizoplane, measures = c("Shannon", "Chao1")) # compute alpha diversity
alpha_div_plane = cbind(alpha_div_plane, Rarefied_physeq_mean_rounded_rhizoplane@sam_data) # add the factor to the new table
alpha_div_plane$WEEK = gsub("(\\d)(WEEK)", "\\1 \\2", alpha_div_plane$WEEK) # add a space between the week number and the word WEEK

alpha_div_sphere = estimate_richness(Rarefied_physeq_mean_rounded_rhizosphere, measures = c("Shannon", "Chao1")) # compute alpha diversity
alpha_div_sphere = cbind(alpha_div_sphere, Rarefied_physeq_mean_rounded_rhizosphere@sam_data) # add the factor to the new table
alpha_div_sphere$WEEK = gsub("(\\d)(WEEK)", "\\1 \\2", alpha_div_sphere$WEEK) # add a space between the week number and the word WEEK

```

- Rhizoplane
```{r alpha_diversity_rhizoplane, include=TRUE}
alpha_box_plot(data = alpha_div_plane, x_var = "Irrigation",  y_var = "Shannon", col = "Irrigation", facet = "WEEK", comparizon = comparison, nb_test = nb_test, name = "rhizoplane")

alpha_box_plot(data = alpha_div_plane, x_var = "Irrigation",  y_var = "Chao1", col = "Irrigation", facet = "WEEK", comparizon = comparison, nb_test = nb_test, name = "rhizoplane")
wilcox.test(alpha_div_plane$Shannon[alpha_div_plane$Irrigation == "Watered" & alpha_div_plane$WEEK == "4weeks"], 
            alpha_div_plane$Shannon[alpha_div_plane$Irrigation == "Drought" & alpha_div_plane$WEEK == "4weeks"])$p.value *2

wilcox.test(alpha_div_plane$Shannon[alpha_div_plane$Irrigation == "Watered" & alpha_div_plane$WEEK == "5weeks"], 
            alpha_div_plane$Shannon[alpha_div_plane$Irrigation == "Drought" & alpha_div_plane$WEEK == "5weeks"])$p.value *2
```

- Rhizosphere
```{r alpha_diversity_rhizosphere, include=TRUE}
alpha_box_plot(data = alpha_div_sphere, x_var = "Irrigation",  y_var = "Shannon", col = "Irrigation", facet = "WEEK", comparizon = comparison, nb_test = nb_test, name = "rhizoplane")
alpha_box_plot(data = alpha_div_sphere, x_var = "Irrigation",  y_var = "Chao1", col = "Irrigation", facet = "WEEK", comparizon = comparison, nb_test = nb_test, name = "rhizoplane")
```

- Rhizoplane vs rhizosphere
```{r alpha_diversity_rhizoplane_vs_rhizosphere, include=TRUE}
comparison = list(c("rhizoplane", "rhizosphere"))
alpha_box_plot(data = rbind(alpha_div_sphere, alpha_div_plane), x_var = "Compartments",  y_var = "Shannon", col = "Irrigation", facet = "WEEK", comparizon = comparison, nb_test = nb_test, name = "rhizoplane_rhizosphere")
````

### Beta diversity

```{r beta_diversity function, include=FALSE}
plot_pcoa = function(data, color, cluster, filename){
    list_output = list() # to return the plot and the beta diversity results
    print("Computing PCoA")
    physeq.ord_pcoa = ordinate(data, "PCoA", "bray")
    print("Plotting PCoA")
    p3 = plot_ordination(data, physeq.ord_pcoa, color=color,  
                  title="Beta diversity study using PCoA method (Bray-Curtis dissimilarity)") +
          geom_point(size = 3)+
          theme(axis.text = element_text(size = 15), axis.title = element_text(size = 25), 
                legend.text = element_text(size = 22), legend.title = element_text(size = 25))

    # add the elipse on the plot
    p3 = p3 + stat_ellipse(aes_(color = as.name(cluster), fill = as.name(cluster)), geom = "polygon", show.legend = T, linetype = "dashed", linewidth = 1, alpha = 0.1) +
          labs(color = "Groups", fill = "Groups")+
          scale_color_manual(values = c("Week 2 control" = "#F8766D", # change the color of the groups points
                                        "Week 4 drought" = "#B79F00", 
                                        "Week 4 control" = "#00BA38", 
                                        "Week 5 control" = "#F564E3", 
                                        "Week 5 drought" = "#619CFF")) +
          scale_fill_manual(values = c("Week 2 control" = "#F8766D", # change the color of the groups ellipse
                                       "Week 4 drought" = "#B79F00", 
                                       "Week 4 control" = "#00BA38", 
                                       "Week 5 control" = "#F564E3", 
                                       "Week 5 drought" = "#619CFF"))
    ggsave(filename)
    list_output[[1]] = p3
    list_output[[2]] = physeq.ord_pcoa
    return(list_output)
}
```
- Rhizoplane
```{r beta_diversity plane, include=TRUE}
Rarefied_physeq_mean_rounded_rhizoplane@sam_data$Name2 = ifelse(Rarefied_physeq_mean_rounded_rhizoplane@sam_data$Name2 == "W2RPC" , "Week 2 control",
                                                                 ifelse(Rarefied_physeq_mean_rounded_rhizoplane@sam_data$Name2 == "D4RPC", "Week 4 drought", 
                                                                 ifelse(Rarefied_physeq_mean_rounded_rhizoplane@sam_data$Name2 == "W4RPC", "Week 4 control",
                                                                 ifelse(Rarefied_physeq_mean_rounded_rhizoplane@sam_data$Name2 == "W5RPC", "Week 5 control","Week 5 drought"))))

out = plot_pcoa(Rarefied_physeq_mean_rounded_rhizoplane, "Name2", "Name2", "output/beta_diversity_rhizoplane.png")
saveRDS(out[[2]], "output/physeq_ord_pcoa_rhizoplane.rds")
```

- Rhizosphere
```{r beta_diversity sphere, include=TRUE}
plot_pcoa(Rarefied_physeq_mean_rounded_rhizosphere, "Name2", "Name2", "output/beta_diversity_rhizosphere.png")
```

#### PERMANOVA

```{r permanova, include=TRUE}
permanova = function(physeq, var1, var2 = NULL, var3 = NULL, var4 = NULL, var5 = NULL, matrix = "bray"){
  cat("Preparing data for PERMANOVA\n")
    data = as.data.frame((t(physeq@otu_table))) # convert the otu_table to a dataframe to perform the permANOVA

    metdata = physeq@sam_data
    data = cbind(data, physeq@sam_data)
    data$Irrigation = as.factor(data$Irrigation)
    data$Week = as.factor(data$Week)
    data$Compartments = as.factor(data$Compartments)
    data$Treatment = as.factor(data$Treatment)
    data$Group= as.factor(data$Group)
    # remove the 6 last columns (metadata variable)
    data_corr = data[, -((ncol(data)-6):ncol(data))]
    cat("Computing Bray-Curtis dissimilarity matrix\n")
    bray_dist = vegdist(data_corr, method = matrix)
    cat("Computing PERMANOVA\n")
    formula_str = paste("bray_dist ~", var1, if (!is.null(var2)) paste("*", var2) else "", 
                        if (!is.null(var3)) paste("*", var3) else "", 
                        if (!is.null(var4)) paste("*", var4) else "", 
                        if (!is.null(var5)) paste("*", var5) else "")
    formula = as.formula(formula_str)
    
    model = adonis2(formula, data = data, permutations = 999, by = "terms")
    return(model)
}
```

- Rhizoplane
```{r permanova_rhizoplane, include=TRUE}
permanova(Rarefied_physeq_mean_rounded_rhizoplane, var1 = "Irrigation", var2 = "WEEK")
```


- Rhizosphere
```{r permanova_rhizosphere, include=TRUE}
permanova(Rarefied_physeq_mean_rounded_rhizosphere, var1 = "Irrigation", var2 = "WEEK")
```


### Heatmaps

```{r heatmap function, include=FALSE}

# Function to create the heatmap with ampvis2
my_heatmap = function(df, group, order = NULL, number_ASV = 30){
    plot_heat = amp_heatmap(df, normalise = TRUE, plot_values = T, group_by = group,
                tax_aggregate = "OTU", tax_show = number_ASV, tax_add = c("Family", "Genus"), 
                order_x_by = order, function_data = T) +
                theme(axis.title = element_text(size = 20), axis.text.x = element_text(size = 17), axis.text.y = element_text(size = 17), legend.text = element_text(size = 20))
    return(plot_heat)
}

# function to plot the heatmap and save the top 30 clusters
heat_map_custom = function(data, name){
  (df = my_heatmap(data, "Group", order = c("2W", "4W", "4D", "5W", "5D")))
  print(df)
  ggsave(plot = df, filename = paste0("output/heatmap_", name, ".png"), width = 25, height = 15, units = "cm")
  top_ASV = df$data %>% group_by(Display) %>% # extract the data using dplyr
      summarise(mean = mean(Sum), sd = sd(Sum)) %>% 
        arrange(desc(mean))
  write.table(top_ASV, paste0("output/Top_ASV_", name, ".txt"), sep = "\t", col.names = T, row.names = F)
}
```


- Rhizoplane
```{r plot heatmap plane, include=TRUE}
heat_map_custom(amp_rhizoplane, "rhizoplane") # you can then use the python script "extract_name_cluster.py" to extract the name of the top 30 clusters (generated file) and then launch the blast. To launch the python script type python3 ectract_name_cluster.py in a terminal or direclty the launch button in an IDE
```

- Rhizosphere
```{r plot heatmap sphere, include=TRUE}
heat_map_custom(amp_rhizoplane, "rhizosphere") # the same
```

### % of annotated clusters

```{r annotated_clusters, include=FALSE}

plot_annotation = function(data, type){
  colors = c("#66c2a5", "#fc8d62", "#8da0cb", "#e78ac3", "#a6d854", "#ffd92f", "#e5c494", "#b3b3b3")

  ggplot(data = data, aes(x = 2, y = Freq, fill = Var1))+
      geom_bar(stat = "identity", width = 1, color = "black") +
      coord_polar(theta = "y") + # line to remove to have a stacked barplot
      xlim(0.5, 2.5) +
      geom_text(aes(label = paste0(round(Freq, 3), "%")), 
                position = position_stack(vjust = 0.5)) +
      theme_void() +
      theme(legend.position = "right", legend.text = element_text(size = 15)) +
      labs(fill = "ASV")+
        scale_fill_manual(values = colors) # Utilisation de la palette de couleurs

    ggsave(paste0("output/annotated_clusters_", type ,".png"))
}

compute_freq = function (data){ # fonction to select and compute the proportion of annotated clusters in the data
    asv_table = otu_table(data)
    asv_table = asv_table[rowSums(asv_table)>0,]
    asv_present = rownames(asv_table)
    taxonomy_table = tax_table(data)
    taxonomy_asv = as.data.frame(taxonomy_table[asv_present, ])
    annot = as.data.frame(prop.table(table(taxonomy_asv$superkingdom)) * 100)
    return(annot)
}


annot_plane = compute_freq(physeq_rhizoplane)
annot_sphere = compute_freq(physeq_rhizosphere)
```


- Rhizoplane
```{r annotated_clusters_rhizoplane, include=TRUE}
plot_annotation(annot_plane, "rhizoplane")
```

- Rhizosphere
```{r annotated_clusters_rhizosphere, include=TRUE}
plot_annotation(annot_sphere, "rhizosphere")
```


#### Venn digramm

```{r venn_diagram_function, include=FALSE}
# Function to get only the ASVs which are present in the given subgroup
specific_cluster = function(data){
    asv_table = otu_table(data)
    asv_table = asv_table[rowSums(asv_table)>0,]
    asv_present = rownames(asv_table)
    return(asv_present)
}



generate_venn_for_week = function(week) {
  data_watered = subset_samples(physeq_rhizosplane_ctrl, Irrigation == "Watered" & WEEK == week)
  data_drought = subset_samples(physeq_rhizosphere_ctrl, Irrigation == "Drought" & WEEK == week)
  
  cluster_watered = specific_cluster(data_watered)
  cluster_drought = specific_cluster(data_drought)
  
  venn.plot = draw.pairwise.venn( # create the venn diagram
    area1 = length(cluster_watered),
    area2 = length(cluster_drought),
    cross.area = length(intersect(cluster_watered, cluster_drought)),
    category = c("Watered", "Drought"),
    fill = c("#66c2a5", "#fc8d62"),
    lty = "blank",
    cex = 2,
    cat.cex = 2,
    cat.pos = c(-20, 20),
    cat.dist = c(0.05, 0.05),
    cat.just = list(c(1, 1), c(0, 0))
  )
  grid.newpage()
  grid.draw(venn.plot)
  grid.text(week, x = 0.5, y = 0.1, gp = gpar(fontsize = 20))
  return(venn.plot)
}

```

```{r venn_diagramme_plot, include = TRUE}
# get the list of weeks
weeks = unique(sample_data(physeq_rhizosplane_ctrl)$WEEK)
weeks = weeks[-1]
# Generate plot for each weeks
venn_plots = list()
library(gridExtra)
library(grid)
for (week in weeks) {
  venn.plot = generate_venn_for_week(week)
  venn_plots[[week]] = venn.plot
}

# Save diagrams into png format
png(filename = "venn_diagrams_by_week.png", width = 800, height = 800)
grid.arrange(grobs = venn_plots, ncol = 2)
dev.off()

```